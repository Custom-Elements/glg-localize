<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../iron-icons/editor-icons.html">
<link rel="import" href="../paper-button/paper-button.html">

<dom-module id="glg-localize">
  <template>
    <paper-menu-button horizontal-offset="[[menuOffset]]">
      <paper-icon-button icon="language" class="dropdown-trigger glg-localize-label"></paper-icon-button>
      <content select=".dropdown-trigger"></content>
      <paper-menu id="languageMenu" selected="{{selectedLanguage}}" attr-for-selected="id" class="dropdown-content" on-iron-select="_setLanguageToSelected">
        <template is="dom-repeat" items="{{supportedLanguagesArray}}" as="lang">
          <paper-item id="[[lang.code]]" label="[[lang.displayName]]">
            <span>[[lang.displayName]]</span>
          </paper-item>
        </template>
      </paper-menu>
    </paper-menu-button>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'glg-localize',
    properties: {
      language: {
        type: 'String',
        value: 'en',
        notify: true,
        readOnly: true
      },
      menuOffset: {
        type: 'String',
        value: ''
      },
      preferredLanguage: {
        type: 'String',
        value: function () {return window.localStorage.getItem("languagePreference")}
      },
      selectedLanguage: {
        type: 'String',
        value: null,
        notify: true
      },
      supportedLanguagesArray: {
        type: 'Array',
        value: []
      },
      supportedLanguages: {
        type: 'String',
        value: "", // should be of the form "<lang_code1> : <display_name1>, <lang_code2> : <display_name2>, ..."
        observer: "_parseToArray"
      }
    },
    observers: [
      '_storeLangPref(preferredLanguage, selectedLanguage)'
    ],
    ready: function() {
      // try to load preferred language code from local storage
      var browserLang = (window.navigator.userLanguage || window.navigator.language).split("-")[0];
      if (this.preferredLanguage) {
        this.selectedLanguage = this.preferredLanguage;
      } else if (browserLang) {
        this.selectedLanguage = browserLang;
      }
    },
    _parseToArray: function (newLangs, oldLangs) {
      if (newLangs && newLangs !== oldLangs) {
        newLangs.split(",").forEach(function(item) {
          var props = item.trim().split(":");
          if (props.length === 2) this.push("supportedLanguagesArray", {code: props[0].trim(), displayName: props[1].trim()});
        }, this);
      }
    },
    // because this.language has readOnly=true, this function MUST be of the form '_set' + property name
    _setLanguageToSelected: function (event) {
      this._setLanguage(event.detail.item.id);
    },
    _storeLangPref: function (prefLangCode, selectedLangCode) {
      // save selectedLangCode as preferred language to local storage
      if (selectedLangCode && selectedLangCode !== prefLangCode) {
        window.localStorage.setItem("languagePreference", selectedLangCode);
      }
    }
  });
</script>
