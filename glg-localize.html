<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../iron-icons/editor-icons.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">

<dom-module id="glg-localize">
  <template>
    <iron-ajax
      id="langLocalization"
      with-credentials
      verbose
      method="get"
      handle-as="json"
      url="[[langLocalizationUrl]]"
      on-request="_startLocalizationSpinner"
      on-response="_setLocalizedResources"
      on-error="_fireLocalizationError"
    >
    </iron-ajax>
    <paper-menu-button horizontal-offset="-25">
      <paper-icon-button icon="language" class="dropdown-trigger"></paper-icon-button>
      <paper-menu on-iron-select="selectLanguage" class="dropdown-content">
        <paper-item value='en'>English</paper-item>
        <paper-item value='fr'>Français</paper-item>
        <paper-item value='de'>Deutsch</paper-item>
        <paper-item value='es'>Español</paper-item>
        <paper-item value='pt'>Português</paper-item>
        <paper-item value='zh'>中文（简体中文)</paper-item>
        <paper-item value='jp'>日本語</paper-item>
      </paper-menu>
    </paper-menu-button>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'glg-localize',
    behaviors: [
      Polymer.AppLocalizeBehavior
    ],
    properties: {
      deleteParams: {
        type: Object,
        value: function () { return {} },
        computed: "_getDeleteParams(isImpersonator,cmId,invoiceId,loggedInPersonId)"
      },
      langLocalizationUrl: {
        type: 'String',
        value: null,
        observer: '_fetchLangLocalization',
        computed: '_setLangLocalizationUrl(language)'
      },
      language: {
        type: 'String',
        value: 'en'
      },
      resources: {
        type: 'Object',
        value: function() {
          return {
            "de": null,   // german
            "en": null,   // english
            "es": null,   // spanish
            "fr": null,   // french
            "jp": null,   // japanese
            "ko": null,   // korean
            "pt": null,   // portuguese
            "zh": null    // chinese
          }
        }
      }
    },
    observers: [
      "_storeLangPref(language)"
    ],
    ready: function() {
      // try to load preferred language code from local storage
      this.language = window.localStorage.getItem("languagePreference") || window.navigator.userLanguage || window.navigator.language;
    },
    _fetchLangLocalization: function () {
      if (this.langLocalizationUrl && this.language && !this.resources[this.language]) this.$.langLocalization.generateRequest();
    },
    _storeLangPref: function (langCode) {
      // save preferred language code to local storage
    },
    _setLangLocalizationUrl: function (langCode) {
      return "//public/locales/" + langCode + ".json"
    },
    _startLocalizationSpinner: function (evt) {
    },
    _setLocalizedResources: function (evt) {
      if (event.detail.response) {
        try {
          this.resources[this.language] = JSON.parse(event.detail.response);
        }
        catch (error) {
          console.warn("Unable to set language resources object from for " + this.language + ".  " + error);
        }
      }
    },
    _fireLocalizationError: function (evt) {
    }
  });
</script>
