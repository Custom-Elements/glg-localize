<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../iron-icons/editor-icons.html">
<link rel="import" href="../paper-button/paper-button.html">

<dom-module id="glg-localize">
  <template>
    <paper-menu-button horizontal-offset="[[menuOffset]]">
      <paper-icon-button icon="language" class="dropdown-trigger glg-localize-label"></paper-icon-button>
      <content select=".dropdown-trigger"></content>
      <paper-menu id="languageMenu" selected="{{language}}" attr-for-selected="id" class="dropdown-content">
        <template is="dom-repeat" items="{{supportedLanguagesArray}}" as="lang">
          <paper-item id="[[lang.code]]" label="[[lang.displayName]]">
            <span>[[lang.displayName]]</span>
          </paper-item>
        </template>
      </paper-menu>
    </paper-menu-button>
  </template>
</dom-module>
<script>
  Polymer({
    is: 'glg-localize',
    properties: {
      language: {
        type: 'String',
        value: 'en',
        notify: true,
        observer: '_storeLangPref'
      },
      supportedLanguagesArray: {
        type: 'Array',
        value: []
      },
      supportedLanguages: {
        type: 'String',
        value: "", // should be of the form "<lang_code1> : <display_name1>, <lang_code2> : <display_name2>, ..."
        observer: "_parseToArray"
      },
      menuOffset: {
        type: 'String',
        value: ''
      }
    },
    attached: function() {
      var myNameArray = this.resolveUrl().split("/");
      var myName = myNameArray[myNameArray.length - 2];
      this.loadResources(myName + ".json");
    },
    ready: function() {
      // try to load preferred language code from local storage
      this.language = window.localStorage.getItem("languagePreference") || (window.navigator.userLanguage || window.navigator.language).split("-")[0];
    },
    _parseToArray: function (newLangs, oldLangs) {
      if (newLangs && newLangs !== oldLangs) {
        newLangs.split(",").forEach(function(item) {
          var props = item.trim().split(":");
          if (props.length === 2) this.push("supportedLanguagesArray", {code: props[0].trim(), displayName: props[1].trim()});
        }, this);
      }
    },
    _storeLangPref: function (newLangCode, oldLangCode) {
      // save preferred language code to local storage
      if (newLangCode && newLangCode !== oldLangCode) window.localStorage.setItem("languagePreference", newLangCode);
    }
  });
</script>
